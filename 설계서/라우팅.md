# URL 라우팅 구조

## 1. 도메인 구조

```
www.container-agent.com          ← 웹 프론트엔드
api.container-agent.com          ← REST API
grpc.container-agent.com         ← gRPC (Agent 연결)
```

---

## 2. 웹 프론트엔드 라우팅

```
www.container-agent.com
│
├── /                                      ← 랜딩 페이지
├── /login                                 ← 로그인
├── /signup                                ← 회원가입
│
├── /dashboard                             ← 대시보드 (내 Agent 목록)
│
├── /agents/new                            ← Agent 등록 (agent_key 발급)
│
├── /:slug                                 ← Agent 메인 (컨테이너 요약)
│   ├── /:slug/containers                  ← 컨테이너 목록
│   ├── /:slug/containers/:id              ← 컨테이너 상세 (Inspect)
│   ├── /:slug/stats                       ← 리소스 모니터링 (차트)
│   ├── /:slug/stats/:id                   ← 개별 컨테이너 Stats 상세
│   ├── /:slug/events                      ← 이벤트 로그 (실시간)
│   └── /:slug/settings                    ← Agent 설정
│
└── /settings                              ← 계정 설정
    ├── /settings/profile                  ← 프로필 수정
    ├── /settings/agents                   ← Agent 관리
    └── /settings/billing                  ← 요금제 관리
```

---

## 3. 접속 예시

```
www.container-agent.com/119agent
├── 119agent의 전체 컨테이너 요약
│   - 호스트 수: 2
│   - 컨테이너 수: 15 (running: 12, stopped: 3)
│   - CPU/Memory 전체 사용량
│
www.container-agent.com/119agent/containers
├── 컨테이너 목록 테이블
│   - ID, Name, Image, State, Host
│   - 필터: host별, state별
│
www.container-agent.com/119agent/containers/a1b2c3d4e5f6
├── 컨테이너 상세 정보
│   - 기본 정보 (ID, Name, Image, Created)
│   - State (status, running, exit_code)
│   - Config (hostname, env, cmd)
│   - Network (ip, gateway, ports)
│   - Mounts (source, destination)
│
www.container-agent.com/119agent/stats
├── 리소스 모니터링 대시보드
│   - CPU 사용률 차트 (시계열)
│   - Memory 사용률 차트
│   - Network I/O 차트
│   - 컨테이너별 리소스 테이블
│
www.container-agent.com/119agent/events
├── 이벤트 로그 (실시간 SSE)
│   - 시간, 호스트, 타입, 액션, 대상
│   - 필터: host별, event type별
```

---

## 4. API Gateway 라우팅 (Nginx)

```nginx
# 웹 프론트엔드
server {
    listen 443 ssl;
    server_name www.container-agent.com;

    # SPA 라우팅 - 모든 경로를 index.html로
    location / {
        root /var/www/frontend;
        try_files $uri $uri/ /index.html;
    }
}

# REST API
server {
    listen 443 ssl;
    server_name api.container-agent.com;

    # Auth Service
    location /api/v1/auth/ {
        proxy_pass http://auth-service:9090;
    }

    # Agent 관리 API
    location /api/v1/agents {
        proxy_pass http://agent-service:9091;
    }

    # 모니터링 데이터 API
    location ~ ^/api/v1/agents/[^/]+/(containers|stats|events|hosts) {
        proxy_pass http://data-service:9092;
    }

    # SSE 이벤트 스트림
    location ~ ^/api/v1/agents/[^/]+/events/stream$ {
        proxy_pass http://data-service:9092;
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding off;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 3600s;
    }
}

# gRPC (Agent 연결)
server {
    listen 443 ssl http2;
    server_name grpc.container-agent.com;

    location / {
        grpc_pass grpc://agent-service:50051;
    }
}
```

---

## 5. 라우팅 흐름

```
사용자 브라우저
    │
    ├── www.container-agent.com/119agent/stats
    │   │
    │   ▼
    │   Nginx (www) → React SPA (index.html)
    │                    │
    │                    ▼ (API 호출)
    │              api.container-agent.com/api/v1/agents/119agent/stats
    │                    │
    │                    ▼
    │              Nginx (api) → Data Service
    │                                │
    │                                ▼
    │                          TimescaleDB (조회)
    │
Agent (119서버)
    │
    ├── grpc.container-agent.com:443
    │   │
    │   ▼
    │   Nginx (grpc) → Agent Service (gRPC Server)
    │                        │
    │                        ▼
    │                  TimescaleDB (저장)
```

---

## 6. slug 규칙

- 소문자 영문, 숫자, 하이픈(-) 허용
- 최소 3자, 최대 50자
- 시작/끝은 영문 또는 숫자
- 예약어 제외: `api`, `admin`, `dashboard`, `login`, `signup`, `settings`, `new`
- 사용자별 유니크 (전역 유니크)

```
유효: 119agent, my-server, prod-01
무효: -agent, agent-, a, my agent, API
```
