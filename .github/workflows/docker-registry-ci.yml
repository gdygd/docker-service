name: docker build & private registry push/pull

on:
  push:
    branches: [ "main" ]

jobs:
  docker-ci:
    runs-on: [self-hosted, docker]

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # 1Ô∏è‚É£ Docker login
      - name: Docker login to private registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | \
          docker login https://${{ secrets.REGISTRY_URL }} \
            --username ${{ secrets.REGISTRY_USER }} \
            --password-stdin

      # 2Ô∏è‚É£ Docker build
      - name: Docker build
        run: |
          docker build \
            -t docker-service:latest \
            -t ${{ secrets.REGISTRY_URL }}/docker-service:latest \
            .

      # 3Ô∏è‚É£ Docker push
      - name: Docker push
        run: |
          docker push ${{ secrets.REGISTRY_URL }}/docker-service:latest

      # 4Ô∏è‚É£ (Í≤ÄÏ¶ù) pull ÌÖåÏä§Ìä∏
      - name: Docker pull verify
        run: |
          docker rmi ${{ secrets.REGISTRY_URL }}/docker-service:latest || true
          docker pull ${{ secrets.REGISTRY_URL }}/docker-service:latest

      # 5Ô∏è‚É£ Stop & remove existing container
      - name: Stop existing container
        run: |
          docker stop docker-service || true
          docker rm docker-service || true

      # 6Ô∏è‚É£ Run new container üöÄ
      - name: Run docker-service
        run: |
          docker run -d \
            --name docker-service \
            -p 9083:9083 \
            -v /home/gildong/work/go/src/docker_mng/docker_service/certs:/certs:ro \
            --restart unless-stopped \
            ${{ secrets.REGISTRY_URL }}/docker-service:latest