# ===========================================
# Docker Compose - Production (OPR Mode)
# ===========================================
# Usage:
#   docker compose up -d                    # 운영 모드 (기본)
#   docker compose --profile dev up -d      # 개발 모드
#   docker compose down                     # 종료
# ===========================================

services:
  # -----------------------------------------
  # API Gateway
  # -----------------------------------------
  api-gateway:
    image: ${REGISTRY_URL:-theroad-ygd.com:5000}/api-gateway:latest
    container_name: api-gateway
    ports:
      - "9081:9081"
    volumes:
      - ../services/api-gateway/bin/app.env:/app/app.env:ro
    command: ["-MODE=1"]  # 운영 모드
    depends_on:
      - auth-service
      - docker-service
    networks:
      - docker-mng
    restart: unless-stopped

  # API Gateway (개발 모드) - profile로 선택
  api-gateway-dev:
    image: ${REGISTRY_URL:-theroad-ygd.com:5000}/api-gateway:latest
    container_name: api-gateway-dev
    profiles: ["dev"]
    ports:
      - "9081:9081"
    volumes:
      - ../services/api-gateway/bin/app.env:/app/app.env:ro
    command: ["-MODE=0"]  # 개발 모드
    networks:
      - docker-mng
    restart: unless-stopped

  # -----------------------------------------
  # Auth Service
  # -----------------------------------------
  auth-service:
    image: ${REGISTRY_URL:-theroad-ygd.com:5000}/auth-service:latest
    container_name: auth-service
    ports:
      - "9090:9090"      # REST API
      - "9190:9190"      # gRPC
      - "9091:9091"      # gRPC Gateway
    environment:
      - DB_DRIVER=mariadb
      - DB_ADDRESS=docker_mariadb
      - DB_PORT=3306
      - DB_USER=dev
      - DB_PASSWD=dev
      - DB_NAME=docker
    volumes:
      - ../services/auth_service/bin/app.env:/app/app.env:ro
    networks:
      - docker-mng
    restart: unless-stopped

  # -----------------------------------------
  # Docker Service
  # -----------------------------------------
  docker-service:
    image: ${REGISTRY_URL:-theroad-ygd.com:5000}/docker-service:latest
    container_name: docker-service
    ports:
      - "9083:9083"
    environment:
      - CERT_PATH=/certs
    volumes:
      - ../services/docker_service/bin/app.env:/app/app.env:ro
      - /home/gildong/work/go/src/docker_mng/docker_service/services/docker_service/certs:/certs:ro
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - docker-mng
    restart: unless-stopped

# -----------------------------------------
# Networks
# -----------------------------------------
networks:
  docker-mng:
    external: true

# -----------------------------------------
# Volumes
# -----------------------------------------
volumes:
  mariadb_data:
